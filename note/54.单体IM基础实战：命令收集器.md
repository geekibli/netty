# 54 命令收集器模块实现以及简介


## 什么是命令收集器

首先我们的单体IM架构的重点侧重于通讯部分和服务端的设计，用户端的注册页面和登录页面等我们都采用控制台的方式模拟。


命令收集器的职能就是用来收集客户端输入的指令，进而完成用户后续的操作。



## 命令收集器都有哪些


首先有一个命令收集的接口

```java
public interface BaseCommand {

	//获取命令的key
	String getKey();

	//获取命令的提示信息
	String getTip();

	//从控制台提取 业务数据
	void exec(Scanner scanner);

}
```

实现类分别有 👇

- ChatConsoleCommand： 收集用户聊天消息
- ClientCommandMenu： 菜单显示
- LoginConsoleCommand： 用户登录指令收集
- LogoutConsoleCommand： 登出指令



## 指令收集器工作原理


- 首先是客户端启动的时候，加载所有的命令
- 客户端启动之后，控制台可以打印已经加载的命令收集器，也就是说，客户端目前提供了哪些功能
- 然后用户根据控制台提示的指令就可以进行功能使用了，比如登录，聊天等


```java
  //启动聊天客户端
private static void startChatClient(ApplicationContext context) {
	CommandController commandClient = context.getBean(CommandController.class);
	
	// 加载所有命令
	commandClient.initCommandMap();
	try {
		commandClient.commandThreadRunning();

	} catch (InterruptedException e) {
		e.printStackTrace();
	}
}
```

### 加载所有命令收集器，存放到一个map中

```java
public void initCommandMap() {
	commandMap = new HashMap<>();
	commandMap.put(clientCommandMenu.getKey(), clientCommandMenu);
	commandMap.put(chatConsoleCommand.getKey(), chatConsoleCommand);
	commandMap.put(loginConsoleCommand.getKey(), loginConsoleCommand);
	commandMap.put(logoutConsoleCommand.getKey(), logoutConsoleCommand);
	clientCommandMenu.setAllCommand(commandMap);
}
```

客户端完成连接之后呢，命令收集服务启动。

一个while循环，不断监听客户端输入的数据，然后解析数据，根据数据不同的类型，做出不同的处理。具体可以看一下下面的switch分流。

```java
public void commandThreadRunning() throws InterruptedException {
	Thread.currentThread().setName("命令线程");

	while (true) {
		//建立连接
		while (connectFlag == false) {
			//开始连接
			startConnectServer();
			waitCommandThread();

		}
		//处理命令
		while (null != session) {

			Scanner scanner = new Scanner(System.in);
			clientCommandMenu.exec(scanner);
			String key = clientCommandMenu.getCommandInput();
			BaseCommand command = commandMap.get(key);

			if (null == command) {
				System.err.println("无法识别[" + command + "]指令，请重新输入!");
				continue;
			}


			switch (key) {
				case ChatConsoleCommand.KEY:
					command.exec(scanner);
					startOneChat((ChatConsoleCommand) command);
					break;

				case LoginConsoleCommand.KEY:
					command.exec(scanner);
					startLogin((LoginConsoleCommand) command);
					break;

				case LogoutConsoleCommand.KEY:
					command.exec(scanner);
					startLogout(command);
					break;

			}
		}
	}
}
```


## 环境配置

点击Help -> Edit custom vm Options， 添加如下

```
-Deditable.java.test.console=true
```

**然后重启IDE生效！！！**


## 测试程序

简易代码收集命令测试程序。

```
 @Test
	public void testCommandController() {
		initCommandMap();
		//处理命令
		while (true) {

			//菜单输入
			Scanner scanner = new Scanner(System.in);
			clientCommandMenu.exec(scanner);
			String key = clientCommandMenu.getCommandInput();

			//根据菜单输入，选择正确的命令收集器
			BaseCommand command = commandMap.get(key);

			if (null == command) {
				System.err.println("无法识别[" + key + "]指令，请重新输入!");
				continue;
			}

			//执行命令收集器
			switch (key) {
				case LoginConsoleCommand.KEY:
					command.exec(scanner);
					Logger.info("本次输入的 username 为：");
					Logger.info(((LoginConsoleCommand) command).getUserName());
					Logger.info("本次输入的 password 为：");
					Logger.info(((LoginConsoleCommand) command).getPassword());

//                    startLogin((LoginConsoleCommand) command);
					break;

				case LogoutConsoleCommand.KEY:
					command.exec(scanner);
//                    startLogout((LoginConsoleCommand) command);
					break;
			}
		}
	}

	public void initCommandMap() {
		commandMap = new HashMap<>();
		LoginConsoleCommand loginConsoleCommand = new LoginConsoleCommand();
		LogoutConsoleCommand logoutConsoleCommand = new LogoutConsoleCommand();
		commandMap.put(clientCommandMenu.getKey(), clientCommandMenu);
		commandMap.put(loginConsoleCommand.getKey(), loginConsoleCommand);
		commandMap.put(logoutConsoleCommand.getKey(), logoutConsoleCommand);
		clientCommandMenu.setAllCommand(commandMap);
	}
```



### 测试结果

```
请输入某个操作指令：[menu] 0->show 所有命令 | 1->登录 | 10->退出 | 
1
请输入用户信息(id@password)  
2
请按照格式输入(id@password):
```






































