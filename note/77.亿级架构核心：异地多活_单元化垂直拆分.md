# 77 亿级架构核心：异地多活_单元化垂直拆分


## 什么是单元化

服务使用多机房，多AZ（可用区）来部署，保证可用性



## 为什么需要单元化


- 多AZ(可用区域), 容灾

- 服务器体量太大，单个机房不足以支撑，机器不够

- 提升用户请求访问速度

## 单元化的演化进程

容灾是单元化的最重要的应用场景之一。


### 单IDC时代

最早的单元化架构，是多个服务链接到一个DB实例上。

<img src="https://oscimg.oschina.net/oscnet/up-5987094a9712869fbbb7cd7c65602fb57d2.png" width=500 height=400> 


### 多机房容灾
 
多机房容灾可以避免单个机房因为不可抗因素等等原因导致整个数据中心或者系统瘫痪。

同一个idc机房的DB，开启了mysql半同步机制，并设置半同步超时报警。

不同一个idc机房的主DB 开启了异步复制。

对于跨idc机房的数据访问，至少有一个数据异步复制完成，才能进行。牺牲一部分可用性换取强一致性。

![](https://oscimg.oschina.net/oscnet/up-7721b19245ab241627b29341cc025202c76.png)


IDC进行数据异步同步，如果DB1出现问题，将数据库瞬间切换到DB3，对于idc1来说，如果数据没有复制完成，中间有一段时间不可用。

当DB1恢复时，再吧没有同步的数据和DB3进行合并，按照最后发生为准。（Update可能被覆盖，delete未被更改的话有效，insert判断有无覆盖，当然也少不了**人工对账**）


### 异地多活

更可靠的一种方案时，在不同的城市开辟多个机房，做到异地多机房。

![](https://oscimg.oschina.net/oscnet/up-dedc071568909ee20fe24ed33dac16d633c.png)

在这样的架构设计下，城市A停电了，可以切换流量到城市B。

对于跨idc机房的数据访问，至少有一个号数据异步复制完成，才能进行，牺牲一部分可用性换取强一致性。

只是，数据的复制时间 ，变得更长了。切流量的时候，不可用的时间会比较久。

## 单元化的定义

**所谓单元，就是指一个能完成所有业务操作的自包含集合，在这个集合中包含了所有业务所需的所有服务，以及，单元化的数据分片。**

单元化架构就是把单元作为系统部署的基本单位，在全站所有的idc机房中部署多个单元。

每个idc机房里的单元数量不定，任意一个单元都部署了系统所需的所有的服务。

任意一个单元的数据是首先拥有分片数据，但是为了切流的方便，最终需要拥有**全量数据**。
 
**而做到单元化，必须满足一下要求**

1. 业务必须是可分片的，如 淘宝按照用户分片，饿了么按照地理位置分片
2. 单元内的业务是自包含的，调用尽量封闭。


## 单元化的基础组件

### 全局路由网关 

主要工作就是识别用户请求并将请求转发到正确的单元中。

比如说饿了么按照地理位置进行请求的分片处理：

![](https://oscimg.oschina.net/oscnet/up-84b575140da21194bfecc2b4b6a22e1969f.png)





